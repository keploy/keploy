package mcp

import "fmt"

// generateGitHubActionsWorkflow generates a GitHub Actions workflow for Keploy mock testing.
func generateGitHubActionsWorkflow(config PipelineConfig) string {
	return fmt.Sprintf(`# Keploy Mock Test Workflow
# This workflow runs Keploy mock tests on pull requests and merges to %s
# Generated by Keploy MCP Tool

name: Keploy Mock Test

on:
  pull_request:
    branches: [%s]
  push:
    branches: [%s]

jobs:
  keploy-mock-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Keploy
        run: |
          curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
          sudo mv /tmp/keploy /usr/local/bin/keploy
          keploy --version

      - name: Run Keploy Mock Test
        run: |
          keploy mock test --command "%s" --mockPath "%s"
        env:
          # Add any environment variables your app needs
          CI: true
`,
		config.DefaultBranch,
		config.DefaultBranch,
		config.DefaultBranch,
		config.AppCommand,
		config.MockPath,
	)
}

// generateGitLabCIPipeline generates a GitLab CI/CD pipeline for Keploy mock testing.
func generateGitLabCIPipeline(config PipelineConfig) string {
	return fmt.Sprintf(`# Keploy Mock Test Pipeline
# This pipeline runs Keploy mock tests on merge requests and merges to %s
# Generated by Keploy MCP Tool

stages:
  - test

variables:
  KEPLOY_MOCK_PATH: "%s"
  APP_COMMAND: "%s"

keploy-mock-test:
  stage: test
  image: ubuntu:22.04
  
  rules:
    - if: $CI_MERGE_REQUEST_ID
    - if: $CI_COMMIT_BRANCH == "%s"
  
  before_script:
    - apt-get update && apt-get install -y curl tar
    - curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
    - mv /tmp/keploy /usr/local/bin/keploy
    - keploy --version
  
  script:
    - keploy mock test --command "${APP_COMMAND}" --mockPath "${KEPLOY_MOCK_PATH}"
`,
		config.DefaultBranch,
		config.MockPath,
		config.AppCommand,
		config.DefaultBranch,
	)
}

// generateJenkinsfile generates a Jenkinsfile for Keploy mock testing.
func generateJenkinsfile(config PipelineConfig) string {
	return fmt.Sprintf(`// Keploy Mock Test Pipeline
// This pipeline runs Keploy mock tests on pull requests and merges to %s
// Generated by Keploy MCP Tool

pipeline {
    agent any

    environment {
        KEPLOY_MOCK_PATH = '%s'
        APP_COMMAND = '%s'
    }

    triggers {
        // Trigger on PRs and merges to %s
        pollSCM('H/5 * * * *')
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Setup Keploy') {
            steps {
                sh '''
                    curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
                    sudo mv /tmp/keploy /usr/local/bin/keploy
                    keploy --version
                '''
            }
        }

        stage('Keploy Mock Test') {
            steps {
                sh '''
                    keploy mock test --command "${APP_COMMAND}" --mockPath "${KEPLOY_MOCK_PATH}"
                '''
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
`,
		config.DefaultBranch,
		config.MockPath,
		config.AppCommand,
		config.DefaultBranch,
	)
}

// generateCircleCIConfig generates a CircleCI configuration for Keploy mock testing.
func generateCircleCIConfig(config PipelineConfig) string {
	return fmt.Sprintf(`# Keploy Mock Test Pipeline
# This pipeline runs Keploy mock tests on pull requests and merges to %s
# Generated by Keploy MCP Tool

version: 2.1

executors:
  default:
    docker:
      - image: cimg/base:current
    working_directory: ~/project

jobs:
  keploy-mock-test:
    executor: default
    steps:
      - checkout
      
      - run:
          name: Setup Keploy
          command: |
            curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
            sudo mv /tmp/keploy /usr/local/bin/keploy
            keploy --version
      
      - run:
          name: Run Keploy Mock Test
          command: |
            keploy mock test --command "%s" --mockPath "%s"
          environment:
            CI: true

workflows:
  version: 2
  keploy-mock-test-workflow:
    jobs:
      - keploy-mock-test:
          filters:
            branches:
              only:
                - %s
                - /^(pull|merge)\/.*$/
`,
		config.DefaultBranch,
		config.AppCommand,
		config.MockPath,
		config.DefaultBranch,
	)
}

// generateAzurePipeline generates an Azure Pipelines configuration for Keploy mock testing.
func generateAzurePipeline(config PipelineConfig) string {
	return fmt.Sprintf(`# Keploy Mock Test Pipeline
# This pipeline runs Keploy mock tests on pull requests and merges to %s
# Generated by Keploy MCP Tool

trigger:
  branches:
    include:
      - %s

pr:
  branches:
    include:
      - %s

pool:
  vmImage: 'ubuntu-latest'

variables:
  KEPLOY_MOCK_PATH: '%s'
  APP_COMMAND: '%s'

steps:
  - checkout: self
    displayName: 'Checkout code'

  - script: |
      curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
      sudo mv /tmp/keploy /usr/local/bin/keploy
      keploy --version
    displayName: 'Setup Keploy'

  - script: |
      keploy mock test --command "$(APP_COMMAND)" --mockPath "$(KEPLOY_MOCK_PATH)"
    displayName: 'Run Keploy Mock Test'
    env:
      CI: true
`,
		config.DefaultBranch,
		config.DefaultBranch,
		config.DefaultBranch,
		config.MockPath,
		config.AppCommand,
	)
}

// generateBitbucketPipeline generates a Bitbucket Pipelines configuration for Keploy mock testing.
func generateBitbucketPipeline(config PipelineConfig) string {
	return fmt.Sprintf(`# Keploy Mock Test Pipeline
# This pipeline runs Keploy mock tests on pull requests and merges to %s
# Generated by Keploy MCP Tool

image: ubuntu:22.04

definitions:
  steps:
    - step: &keploy-mock-test
        name: Keploy Mock Test
        script:
          - apt-get update && apt-get install -y curl tar
          - curl --silent --location "https://github.com/keploy/keploy/releases/latest/download/keploy_linux_amd64.tar.gz" | tar xz -C /tmp
          - mv /tmp/keploy /usr/local/bin/keploy
          - keploy --version
          - keploy mock test --command "%s" --mockPath "%s"

pipelines:
  pull-requests:
    '**':
      - step: *keploy-mock-test

  branches:
    %s:
      - step: *keploy-mock-test
`,
		config.DefaultBranch,
		config.AppCommand,
		config.MockPath,
		config.DefaultBranch,
	)
}

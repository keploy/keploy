name: Prepare Binary and Run Workflows (Windows)
on:
  pull_request:
    branches: [main]

jobs:
  build-and-upload:
    runs-on: [self-hosted, Windows, X64]
    steps:
      - name: Aggressive Cleanup (Workspace + Keploy procs)
        if: always()
        shell: powershell
        continue-on-error: true
        run: |
          # Kill any lingering Keploy processes
          $procs = 'keploy.exe','keploy-record.exe','keploy-replay.exe','keploy-record','keploy-replay'
          foreach ($p in $procs) { cmd /c "taskkill /F /IM $p /T" 2>$null | Out-Null }

          # Clean workspace artifacts that could affect the build
          $paths = @('.\bin','.\\keploy.exe','.\\keploy','.\\keploy.yml','.\\record-bin','.\\replay-bin')
          foreach ($p in $paths) {
            Remove-Item -LiteralPath $p -Recurse -Force -ErrorAction SilentlyContinue
          }

          # Optional: clean Go caches to avoid stale behavior
          go version 2>$null | Out-Null
          if ($LASTEXITCODE -eq 0) {
            go clean -cache -modcache -testcache -fuzzcache 2>$null
          }

      - name: Clean up git config (ensure HTTPS for checkout)
        if: always()
        continue-on-error: true
        shell: powershell
        run: |
          git config --global --unset-all url."git@github.com:".insteadof  2>$null
          git config --global --unset-all url."ssh://git@github.com/".insteadof  2>$null
          git config --global --unset-all core.sshCommand  2>$null
          git config --global --list

      - name: Configure Git EOL on Windows
        shell: powershell
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0
          clean: true

      - name: Build Keploy (PR) - Windows (windows/amd64)
        shell: powershell
        run: |
          $env:GOOS = "windows"
          $env:GOARCH = "amd64"
          $env:CGO_ENABLED = "0"
          go build -tags=viper_bind_struct -o keploy.exe ./main.go

      - name: Upload build artifact (Windows CLI)
        uses: actions/upload-artifact@v4
        with: 
          name: build
          path: keploy.exe

      - name: Clean up git config
        if: always()
        continue-on-error: true
        shell: powershell
        run: |
          git config --global --unset url."git@github.com:".insteadOf

  docker-image-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set PR image tag
        run: echo "PR_IMAGE_TAG=ghcr.io/${GITHUB_REPOSITORY}:pr-${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build PR Docker image (linux/amd64) -> tar
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          tags: ${{ env.PR_IMAGE_TAG }}
          outputs: type=docker,dest=keploy-image-pr.tar

      - name: Upload PR Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-build
          path: keploy-image-pr.tar

  # upload-latest:
  #   runs-on: [self-hosted, Windows, X64]
  #   steps:
  #     - name: Download latest release (Windows)
  #       shell: powershell
  #       run: |
  #         # Get latest release tag
  #         $response = Invoke-RestMethod -Uri "https://api.github.com/repos/keploy/keploy/releases/latest"
  #         $latest = $response.tag_name
  #         Write-Host "Latest version: $latest"
          
  #         # Download Windows tar.gz
  #         $url = "https://github.com/keploy/keploy/releases/download/$latest/keploy_windows_amd64.tar.gz"
  #         Write-Host "Downloading from: $url"
          
  #         Invoke-WebRequest -Uri $url -OutFile "keploy.tar.gz"
          
  #         tar -xzf keploy.tar.gz
  #         if (Test-Path "keploy") { Move-Item "keploy" "keploy.exe" }

  #     - name: Upload latest artifact (Windows CLI)
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: latest
  #         path: keploy.exe

  #     - name: Download & save latest Docker image
  #       shell: pwsh
  #       run: |
  #         $response = Invoke-RestMethod -Uri "https://api.github.com/repos/keploy/keploy/releases/latest"
  #         $latest = $response.tag_name
  #         Write-Host "Pulling ghcr.io/keploy/keploy:$latest"
  #         docker pull ghcr.io/keploy/keploy:$latest
  #         docker save ghcr.io/keploy/keploy:$latest -o keploy-image-latest.tar

  #     - name: Upload latest Docker image artifact
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: docker-latest
  #         path: keploy-image-latest.tar

  run_golang_docker_windows:
    needs: [build-and-upload, docker-image-build, upload-latest]
    uses: ./.github/workflows/golang_docker_windows.yml

  run_python_docker_windows:
    needs: [build-and-upload, docker-image-build, upload-latest]
    uses: ./.github/workflows/python_docker_windows.yml
name: Test Colima Support

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    test-colima:
        runs-on: macos-13
        timeout-minutes: 30

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install Docker CLI and Colima
              run: |
                  brew install docker colima

            - name: Start Colima
              run: |
                  colima start --cpu 2 --memory 4 --disk 10

            - name: Verify Docker connectivity
              run: |
                  docker context ls
                  docker info

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Checkout samples-go repository
              uses: actions/checkout@v4
              with:
                  repository: keploy/samples-go
                  path: samples-go

            - name: Run Colima support test
              shell: bash
              run: |
                  cd samples-go/gin-mongo
                  bash $GITHUB_WORKSPACE/.github/workflows/test_workflow_scripts/colima/colima-docker-macos.sh

            - name: Upload Keploy artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: keploy-colima-test-results
                  path: samples-go/gin-mongo/keploy/
                  retention-days: 7

            - name: Cleanup
              if: always()
              run: |
                  docker stop ginApp-1 ginApp-2 ginApp-test keploy-record-1 keploy-record-2 keploy-test mongoDb 2>/dev/null || true
                  docker rm ginApp-1 ginApp-2 ginApp-test keploy-record-1 keploy-record-2 keploy-test mongoDb 2>/dev/null || true
                  docker network rm keploy-network 2>/dev/null || true
                  colima stop || true

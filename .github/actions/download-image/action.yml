name: pull-image
description: "Pull Image"
inputs:
  image_tag:
    description: "Docker image tag or digest to pull"
    required: false
    default: ttl.sh/keploy/keploy:1h
  version:
    description: "Version string to tag the pulled image with"
    required: false
    default: 2-dev
runs:
  using: composite
  steps:
    - name: Pull Image (Unix)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -euo pipefail
        IMAGE_REF="${{ inputs.image_tag }}"
        echo "Pulling ${IMAGE_REF} ..."
        docker pull "${IMAGE_REF}"

        # Retag to the name your stack expects
        # Works for both tag refs and digest refs
        docker tag "${IMAGE_REF}" ghcr.io/keploy/keploy:v${{ inputs.version }}
        docker images | awk 'NR==1 || /keploy\/keploy/ {print}'

    - name: Pull Image (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $IMAGE_REF = "${{ inputs.image_tag }}"
        Write-Host "Pulling $IMAGE_REF ..."
        docker pull $IMAGE_REF

        # Retag to the name your stack expects (works for tags and digests)
        docker tag $IMAGE_REF ghcr.io/keploy/keploy:v${{ inputs.version }}
        docker images --format "{{.Repository}}:{{.Tag}}" | Select-String -Pattern "keploy/keploy" -SimpleMatch